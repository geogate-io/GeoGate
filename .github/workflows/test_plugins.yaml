name: Test plugins

env:
  spack_version: v1.0.0-alpha.2
  esmf_version: develop
  compiler_version: latest
  install_dir: ${{ github.workspace }}/app

on:
  #push:
  #  branches: [ main ]
  #pull_request:
  #  types: [opened, synchronize, reopened, labeled, unlabeled]
  #  branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
    - name: Install Core Development Tools
      run: |
        sudo apt-get -qq update
        sudo apt-get -qq install tar unzip file gringo
        sudo apt-get -qq install build-essential binutils-dev gfortran
        sudo apt-get -qq build-dep lmod
        lua_ver=$(which lua | xargs realpath -e | xargs basename)
        sudo apt-get -qq install lib${lua_ver}-dev tcl-dev
      shell: bash

    - name: Checkout Component Repository
      uses: actions/checkout@v4
      with:
        path: ${{ env.install_dir }}/geogate
        
    - name: Create Spack Environment and Install Dependencies
      run: |
        ${{ env.install_dir }}/geogate/.github/workflows/scripts/install_deps.sh 
      shell: bash

    - name: Restore Dependencies
      uses: actions/cache@v4
      with:
        path: ${{ env.install_dir }}/spack
        key: spack-${{ runner.os }}-${{ inputs.architecture }}-${{ hashFiles('**/spack.lock') }}
        restore-keys: |
          spack-${{ runner.os }}-${{ inputs.architecture }}-${{ hashFiles('**/spack.lock') }}
